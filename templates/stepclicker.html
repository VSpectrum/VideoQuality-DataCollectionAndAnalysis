<html>
{% load staticfiles %}
    <head>
        <script src="https://code.jquery.com/jquery-2.1.3.min.js"></script>
        <meta id="Viewport" name="viewport" width="initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">

        <link rel="stylesheet" href="{% static 'css/click.css' %}">
    </head>

    <body>
        <div align="center">
            <div align="center" style="display:inline-block; margin:0 auto;">
                <video id="myVid" controls onplaying="this.controls=false" style='max-width: 800px'></video>
                <br/>
                <button class="button" id="Qual1" style="width: 19%; height: 45px; display:inline-block;">Bad</button>
                <button class="button" id="Qual2" style="width: 19%; height: 45px; display:inline-block;">Poor</button>
                <button class="button" id="Qual3" style="width: 19%; height: 45px; display:inline-block;">Fair</button>
                <button class="button" id="Qual4" style="width: 19%; height: 45px; display:inline-block;">Good</button>
                <button class="button" id="Qual5" style="width: 19%; height: 45px; display:inline-block;">Excellent</button>
                <br/><br/>

                <div style="display: block">
                    <div align="center" style="margin:0 auto;">
                        <div align="left" style="margin:0 auto; display: table; font-family: 'Droid Serif', serif; font-size: 15px;">
                            Click the play button on the video player to begin the assessment of the video.<br/>
                            Please click the buttons above <b>whenever you perceive a change</b> in the sample's<br/> quality, unless instructed to do otherwise.<br/><br/>
                            <b>Excellent</b> - signifies that any distortion in the video was unnoticeable<br/> 
                            <b>Good</b> - signifies that lesser quality was noticeable but not a nuisance<br/>
                            <b>Fair</b> - signifies that few distortions obscured content in the sample<br/>
                            <b>Poor</b> - signifies that distortions obscured content in the sample<br/>
                            <b>Bad</b> - the video is unwatchable and content cannot be discerned<br/><br/>
                            If any mistakes are made, Refresh page. After the test, click the submit button below.
                        </div>
                    </div>
                </div>
                <br/>
                <div style="display: block">
                    <div align="center" style="margin:0 auto;">
                        <div align="left" style="margin:0 auto; display: table; font-family: 'Droid Serif', serif; font-size: 15px;">
                            <input type="radio" name="gender" value="M" checked>Male</input><br/>
                            <input type="radio" name="gender" value="F">Female</input><br/><br/>
                            Age: <input type="number" id="age" min="1" max="99"><br/><br/>
                        </div>
                    </div>
                </div>

                <button align="center" class="button" id="SubmBtn" style="width: 25%; height: 45px; display:inline-block;" disabled>Submit</button>
                <br/></br>
                <button align="center" class="button" id="ViewBtn" style="width: 25%; height: 25px; display:inline-block;" disabled>View Collected Data</button>
            </div>
        </div>

        <div id="results"></div>

        <div id="cover"> 
            <div align="center" style="width:100%; margin:0 auto;" ><img src="{% static 'pics/loading1.gif' %}" alt="some_text"></div>
        </div>
    </body>

    <script type="text/javascript">

        var userrateArr = [];
        var ratedateArr = [];
        var keepgoing = true;

        $("#Qual1").click(function(){
            var currentdatetime = new Date();
            userrateArr.push(1);
            ratedateArr.push(currentdatetime);
        });

        $("#Qual2").click(function(){
            var currentdatetime = new Date();
            userrateArr.push(2);
            ratedateArr.push(currentdatetime);
        });

        $("#Qual3").click(function(){
            var currentdatetime = new Date();
            userrateArr.push(3);
            ratedateArr.push(currentdatetime);
        });

        $("#Qual4").click(function(){
            var currentdatetime = new Date();
            userrateArr.push(4);
            ratedateArr.push(currentdatetime);
        });

        $("#Qual5").click(function(){
            var currentdatetime = new Date();
            userrateArr.push(5);
            ratedateArr.push(currentdatetime);
        });

        


        myVid = document.getElementById("myVid");
        var video = $("#myVid"), //jquery-wrapped video element
            mousedown = false;

        video.on('play', function () {
            document.getElementById("Qual1").disabled = false;
            document.getElementById("Qual2").disabled = false;
            document.getElementById("Qual3").disabled = false;
            document.getElementById("Qual4").disabled = false;
            document.getElementById("Qual5").disabled = false;


            var currentdatetime = new Date();

            userrateArr.push(0); // 0 signifies start
            ratedateArr.push(currentdatetime); //start

            window.setTimeout(wrapup, myVid.duration*1000);
        }); 

        function wrapup(){
            keepgoing = false; //video has ended
            myVid.pause();
            document.getElementById("SubmBtn").disabled = false;
            document.getElementById("ViewBtn").disabled = false;
            document.getElementById("Qual1").disabled = true;
            document.getElementById("Qual2").disabled = true;
            document.getElementById("Qual3").disabled = true;
            document.getElementById("Qual4").disabled = true;
            document.getElementById("Qual5").disabled = true;
        }


        video.on('pause', function () {
            if(keepgoing) myVid.play(); //only if video reached its end, it is not allowed to be paused.
        });

        $('#ViewBtn').click(function(){
            window.open("/dataVis/{{UploaderName}}/{{VideoName}}");
        });


        $('#SubmBtn').click(function(){
            for (var i = 0; i < userrateArr.length; i++) {
                console.log(userrateArr[i]);
            }

            var id = '';
            for(id = ''; id.length < 32;) id += Math.random().toString(36).substr(2, 1);

            $.ajax({
                type: "POST",
                url: '/recvData',
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                    ratings: JSON.stringify(userrateArr),
                    daterate: JSON.stringify(ratedateArr),
                    userid: id,
                    usergender: $('input[name="gender"]:checked').val(),
                    userage: $('#age').val(),
                    page: 'SC',
                    pageuploader: "{{UploaderName}}",
                    pagevideo: "{{VideoName}}",
                },
                success: function(data) {
                    alert("Successfully completed");

                    document.getElementById("SubmBtn").disabled = true;
                },
                error: function(xhr, textStatus, errorThrown) {
                    alert("Error Occurred");

                    document.getElementById("SubmBtn").disabled = true;
                }
            });
        });



        $( document ).ready(function() {

            document.getElementById("SubmBtn").disabled = true;
            document.getElementById("ViewBtn").disabled = true;
            document.getElementById("Qual1").disabled = true;
            document.getElementById("Qual2").disabled = true;
            document.getElementById("Qual3").disabled = true;
            document.getElementById("Qual4").disabled = true;
            document.getElementById("Qual5").disabled = true;

            var r = new XMLHttpRequest();
            r.onload = function() {
                myVid.src = URL.createObjectURL(r.response);
                //ready
                $("#cover").fadeOut(100); //after done.
            };
            if (myVid.canPlayType('video/mp4;codecs="avc1.42E01E, mp4a.40.2"')) {
                r.open("GET", "{% static 'vid/'|add:VideoName %}");
            }
            else {
                //error
            }
            r.responseType = "blob";
            r.send();

            $("#cover").fadeIn(100);
            alert("Loading Calibration Video");
        });

    </script>
</html>